<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artinafti — GPU Upscaler</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --bg: #0a0a0b;
  --surface: #111113;
  --surface-2: #18181b;
  --surface-3: #1f1f23;
  --border: #27272a;
  --border-subtle: #1e1e21;
  --text: #e4e4e7;
  --text-dim: #71717a;
  --text-muted: #52525b;
  --accent: #c8ff00;
  --accent-dim: #3d4d00;
  --danger: #ff3b30;
  --danger-dim: #4d1210;
  --success: #32d74b;
  --success-dim: #0f3d16;
  --warning: #ff9f0a;
  --mono: 'DM Mono', monospace;
  --serif: 'Instrument Serif', serif;
  --radius: 6px;
  --transition: 180ms ease;
}

html { font-size: 15px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-weight: 400;
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ── NOISE OVERLAY ── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ── LAYOUT ── */
.shell {
  max-width: 980px;
  margin: 0 auto;
  padding: 2rem 1.5rem 4rem;
}

/* ── HEADER ── */
header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  margin-bottom: 3rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border-subtle);
}

.logo {
  font-family: var(--serif);
  font-size: 2rem;
  font-style: italic;
  letter-spacing: -0.02em;
  color: var(--text);
}

.logo span { color: var(--accent); }

.version {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

/* ── SECTIONS ── */
.section {
  margin-bottom: 2rem;
}

.section-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-subtle);
}

.card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  padding: 1.25rem;
}

/* ── FORM ELEMENTS ── */
select, input[type="text"], input[type="number"], textarea {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.8rem;
  padding: 0.5rem 0.65rem;
  outline: none;
  transition: border-color var(--transition);
  width: 100%;
}

select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.6rem center; padding-right: 2rem; }
select:focus, input:focus, textarea:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 60px; }

label {
  font-size: 0.7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  display: block;
  margin-bottom: 0.35rem;
}

.field { margin-bottom: 0.85rem; }

/* ── BUTTONS ── */
.btn {
  font-family: var(--mono);
  font-size: 0.75rem;
  font-weight: 500;
  padding: 0.55rem 1.1rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  cursor: pointer;
  transition: all var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  white-space: nowrap;
}

.btn:hover { background: var(--surface-3); border-color: var(--text-muted); }
.btn:active { transform: scale(0.98); }

.btn-accent {
  background: var(--accent);
  color: #0a0a0b;
  border-color: var(--accent);
}
.btn-accent:hover { background: #d4ff33; border-color: #d4ff33; }
.btn-accent:disabled { background: var(--accent-dim); color: var(--text-muted); border-color: var(--accent-dim); cursor: not-allowed; }

.btn-danger { border-color: var(--danger); color: var(--danger); }
.btn-danger:hover { background: var(--danger-dim); }

.btn-sm { padding: 0.35rem 0.75rem; font-size: 0.7rem; }

/* ── GPU PANEL ── */
.gpu-row {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 0.75rem;
  align-items: end;
}

.gpu-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  margin-top: 1rem;
}

.status-bar {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-top: 1rem;
  padding: 0.6rem 0.85rem;
  background: var(--surface-2);
  border-radius: var(--radius);
  font-size: 0.75rem;
}

.status-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--text-muted);
  flex-shrink: 0;
}

.status-dot.idle { background: var(--text-muted); }
.status-dot.launching, .status-dot.polling, .status-dot.deploying { background: var(--warning); animation: pulse-dot 1.2s infinite; }
.status-dot.active, .status-dot.ready { background: var(--success); }
.status-dot.error { background: var(--danger); }

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.status-text { color: var(--text-dim); flex: 1; }
.status-text strong { color: var(--text); font-weight: 500; }

.cost-tag {
  font-size: 0.7rem;
  color: var(--accent);
  background: var(--accent-dim);
  padding: 0.2rem 0.5rem;
  border-radius: 3px;
}

/* ── MODEL TABS ── */
.model-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 1.25rem;
  border-bottom: 1px solid var(--border-subtle);
}

.model-tab {
  font-family: var(--mono);
  font-size: 0.72rem;
  font-weight: 400;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 0.6rem 1rem;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  position: relative;
  transition: color var(--transition);
}

.model-tab:hover { color: var(--text-dim); }

.model-tab.active {
  color: var(--accent);
}

.model-tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 1px;
  background: var(--accent);
}

/* ── DROPZONE ── */
.dropzone {
  border: 1px dashed var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}

.dropzone:hover, .dropzone.drag-over {
  border-color: var(--accent);
  background: rgba(200, 255, 0, 0.02);
}

.dropzone-label {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.dropzone-label span {
  color: var(--accent);
  text-decoration: underline;
  text-underline-offset: 2px;
}

.dropzone input { display: none; }

.preview-container {
  position: relative;
  margin-top: 1rem;
  display: none;
}

.preview-container.visible { display: block; }

.preview-img {
  max-width: 100%;
  max-height: 200px;
  border-radius: var(--radius);
  border: 1px solid var(--border-subtle);
}

.preview-info {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 0.4rem;
}

.preview-clear {
  position: absolute;
  top: 0.4rem;
  right: 0.4rem;
  background: rgba(10, 10, 11, 0.85);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-dim);
  font-size: 0.7rem;
  transition: all var(--transition);
}

.preview-clear:hover { border-color: var(--danger); color: var(--danger); }

/* ── PARAM GRID ── */
.param-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.75rem;
}

.param-grid .field-wide {
  grid-column: 1 / -1;
}

/* ── SLIDERS ── */
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  outline: none;
  margin-top: 0.3rem;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid var(--bg);
}

.range-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.range-val {
  font-size: 0.75rem;
  color: var(--accent);
  min-width: 2.5rem;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* ── CHECKBOX ── */
.check-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.check-row input[type="checkbox"] {
  accent-color: var(--accent);
  width: 14px;
  height: 14px;
}

.check-label {
  font-size: 0.75rem;
  color: var(--text-dim);
}

/* ── UPSCALE ACTION ── */
.upscale-actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-subtle);
}

/* ── OUTPUT ── */
.output-card {
  text-align: center;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.output-empty {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.progress-wrap {
  width: 100%;
  display: none;
  margin-bottom: 1rem;
}

.progress-wrap.visible { display: block; }

.progress-track {
  width: 100%;
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  transition: width 400ms ease;
}

.progress-label {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 0.4rem;
  text-align: left;
}

.result-container {
  display: none;
  width: 100%;
}

.result-container.visible { display: block; }

.result-img {
  max-width: 100%;
  max-height: 500px;
  border-radius: var(--radius);
  border: 1px solid var(--border-subtle);
  margin-bottom: 1rem;
}

.result-meta {
  display: flex;
  gap: 1.5rem;
  justify-content: center;
  margin-bottom: 1rem;
  font-size: 0.72rem;
  color: var(--text-dim);
}

.result-meta span strong {
  color: var(--text);
  font-weight: 500;
}

/* ── TOASTS ── */
.toast-container {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  pointer-events: none;
}

.toast {
  font-family: var(--mono);
  font-size: 0.75rem;
  padding: 0.6rem 1rem;
  border-radius: var(--radius);
  background: var(--surface-2);
  border: 1px solid var(--border);
  color: var(--text);
  pointer-events: auto;
  animation: toast-in 300ms ease forwards;
  max-width: 380px;
}

.toast.error { border-color: var(--danger); color: var(--danger); }
.toast.success { border-color: var(--success); color: var(--success); }

.toast.fade-out { animation: toast-out 250ms ease forwards; }

@keyframes toast-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
@keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

/* ── RESPONSIVE ── */
@media (max-width: 640px) {
  .gpu-row { grid-template-columns: 1fr; }
  .param-grid { grid-template-columns: 1fr; }
  header { flex-direction: column; gap: 0.25rem; }
}
</style>
</head>
<body>

<div class="toast-container" id="toasts"></div>

<div class="shell">
  <header>
    <div class="logo"><span>A</span>rtinafti</div>
    <div class="version">gpu upscaler · test console</div>
  </header>

  <!-- ═══════ GPU CONTROL ═══════ -->
  <div class="section">
    <div class="section-label">GPU Instance</div>
    <div class="card">
      <div class="gpu-row">
        <div class="field">
          <label>Instance Type</label>
          <select id="instanceType">
            <option value="">Loading…</option>
          </select>
        </div>
        <div class="field">
          <label>Region</label>
          <select id="region">
            <option value="">Select type first</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div style="display:flex;gap:0.4rem;">
            <button class="btn btn-accent" id="launchBtn" disabled>Launch</button>
            <button class="btn btn-danger btn-sm" id="terminateBtn" style="display:none;">Terminate</button>
          </div>
        </div>
      </div>

      <div class="status-bar" id="statusBar">
        <div class="status-dot idle" id="statusDot"></div>
        <div class="status-text" id="statusText">Idle — no instance running</div>
      </div>
    </div>
  </div>

  <!-- ═══════ UPSCALE ═══════ -->
  <div class="section">
    <div class="section-label">Upscale</div>
    <div class="card">
      <div class="model-tabs">
        <button class="model-tab active" data-model="esrgan">ESRGAN</button>
        <button class="model-tab" data-model="flux">FLUX</button>
        <button class="model-tab" data-model="imagen">Imagen</button>
      </div>

      <!-- Dropzone -->
      <div class="dropzone" id="dropzone">
        <div class="dropzone-label">Drop image here or <span>browse</span></div>
        <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp">
      </div>
      <div class="preview-container" id="previewContainer">
        <img class="preview-img" id="previewImg">
        <button class="preview-clear" id="previewClear">✕</button>
        <div class="preview-info" id="previewInfo"></div>
      </div>

      <!-- ESRGAN Params -->
      <div class="param-grid" id="params-esrgan" style="margin-top:1rem;">
        <div class="field">
          <label>Upscale Factor</label>
          <div class="range-row">
            <input type="range" min="1" max="8" value="4" id="esrgan_upscale_factor">
            <span class="range-val" id="esrgan_upscale_factor_val">4×</span>
          </div>
        </div>
        <div class="field">
          <label>Model</label>
          <select id="esrgan_model">
            <option value="4x-UltraSharp.pth">4x-UltraSharp</option>
            <option value="4x_NMKD-Siax_200k.pth">4x_NMKD-Siax_200k</option>
          </select>
        </div>
        <div class="field">
          <label>Tile Size</label>
          <input type="number" id="esrgan_tile_size" value="512" min="128" max="2048" step="64">
        </div>
        <div class="field" style="display:flex;flex-direction:column;justify-content:end;gap:0.5rem;">
          <label class="check-row">
            <input type="checkbox" id="esrgan_fp16" checked>
            <span class="check-label">FP16</span>
          </label>
          <label class="check-row">
            <input type="checkbox" id="esrgan_two_pass">
            <span class="check-label">Two-pass (16×)</span>
          </label>
        </div>
      </div>

      <!-- FLUX Params -->
      <div class="param-grid" id="params-flux" style="margin-top:1rem;display:none;">
        <div class="field">
          <label>Upscale Factor</label>
          <div class="range-row">
            <input type="range" min="1" max="8" value="4" id="flux_upscale_factor">
            <span class="range-val" id="flux_upscale_factor_val">4×</span>
          </div>
        </div>
        <div class="field">
          <label>Denoise</label>
          <div class="range-row">
            <input type="range" min="0" max="1" step="0.05" value="0.2" id="flux_denoise">
            <span class="range-val" id="flux_denoise_val">0.20</span>
          </div>
        </div>
        <div class="field">
          <label>Steps</label>
          <input type="number" id="flux_steps" value="20" min="1" max="100">
        </div>
        <div class="field">
          <label>Guidance</label>
          <div class="range-row">
            <input type="range" min="1" max="20" step="0.5" value="3.5" id="flux_guidance">
            <span class="range-val" id="flux_guidance_val">3.5</span>
          </div>
        </div>
        <div class="field">
          <label>Seed</label>
          <input type="number" id="flux_seed" value="0" min="0">
        </div>
        <div class="field field-wide">
          <label>Prompt</label>
          <textarea id="flux_prompt" placeholder="Describe desired enhancements…"></textarea>
        </div>
      </div>

      <!-- Imagen Params -->
      <div class="param-grid" id="params-imagen" style="margin-top:1rem;display:none;">
        <div class="field">
          <label>Upscale Factor</label>
          <select id="imagen_upscale_factor">
            <option value="x2">x2</option>
            <option value="x4" selected>x4</option>
          </select>
        </div>
        <div class="field field-wide">
          <label>Prompt</label>
          <textarea id="imagen_prompt" placeholder="Optional prompt…"></textarea>
        </div>
      </div>

      <div class="upscale-actions">
        <div style="font-size:0.7rem;color:var(--text-muted);" id="modelHint">ESRGAN — fast, no prompt needed</div>
        <button class="btn btn-accent" id="runBtn" disabled>Run Upscale</button>
      </div>
    </div>
  </div>

  <!-- ═══════ OUTPUT ═══════ -->
  <div class="section">
    <div class="section-label">Output</div>
    <div class="card output-card" id="outputCard">
      <div class="progress-wrap" id="progressWrap">
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">Processing…</div>
      </div>
      <div class="result-container" id="resultContainer">
        <img class="result-img" id="resultImg">
        <div class="result-meta" id="resultMeta"></div>
        <button class="btn btn-accent btn-sm" id="downloadBtn">Download</button>
      </div>
      <div class="output-empty" id="outputEmpty">No output yet — run an upscale to see results</div>
    </div>
  </div>
</div>

<script>
// ── STATE ──
const state = {
  instanceId: null,
  instanceIp: null,
  gpuStatus: 'idle', // idle | launching | polling | active | deploying | ready | error
  instanceTypes: {},
  selectedFile: null,
  activeModel: 'esrgan',
  jobId: null,
  pollTimer: null,
  jobPollTimer: null,
};

// ── DOM REFS ──
const $ = id => document.getElementById(id);
const instanceTypeSelect = $('instanceType');
const regionSelect = $('region');
const launchBtn = $('launchBtn');
const terminateBtn = $('terminateBtn');
const statusDot = $('statusDot');
const statusText = $('statusText');
const dropzone = $('dropzone');
const fileInput = $('fileInput');
const previewContainer = $('previewContainer');
const previewImg = $('previewImg');
const previewInfo = $('previewInfo');
const previewClear = $('previewClear');
const runBtn = $('runBtn');
const progressWrap = $('progressWrap');
const progressFill = $('progressFill');
const progressLabel = $('progressLabel');
const resultContainer = $('resultContainer');
const resultImg = $('resultImg');
const resultMeta = $('resultMeta');
const downloadBtn = $('downloadBtn');
const outputEmpty = $('outputEmpty');

// ── TOASTS ──
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  $('toasts').appendChild(el);
  setTimeout(() => { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); }, 4000);
}

// ── API HELPERS ──
async function api(path, opts = {}) {
  try {
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
      ...opts,
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || data.error?.message || res.statusText);
    return data;
  } catch (e) {
    toast(e.message, 'error');
    throw e;
  }
}

// ── GPU STATUS ──
function setGpuStatus(status, detail = '') {
  state.gpuStatus = status;
  statusDot.className = `status-dot ${status}`;

  const messages = {
    idle: 'Idle — no instance running',
    launching: 'Launching instance…',
    polling: `Waiting for instance to boot… ${detail}`,
    active: `Instance active — ${detail}`,
    deploying: `Deploying stack to ${detail}…`,
    ready: `Ready — ${detail}`,
    error: `Error — ${detail}`,
  };

  statusText.innerHTML = messages[status] || status;

  const isLive = ['active', 'deploying', 'ready'].includes(status);
  terminateBtn.style.display = isLive || status === 'polling' || status === 'launching' ? '' : 'none';
  launchBtn.disabled = status !== 'idle';
  runBtn.disabled = status !== 'ready' || !state.selectedFile;
}

// ── LOAD INSTANCE TYPES ──
async function loadInstanceTypes() {
  try {
    const data = await api('/api/gpu/instance-types');
    state.instanceTypes = data;

    instanceTypeSelect.innerHTML = '<option value="">Select GPU…</option>';

    for (const [key, val] of Object.entries(data)) {
      const info = val.instance_type;
      const regions = val.regions_with_capacity_available || [];
      if (regions.length === 0) continue;

      const price = (info.price_cents_per_hour / 100).toFixed(2);
      const opt = document.createElement('option');
      opt.value = info.name;
      opt.textContent = `${info.description} — $${price}/hr`;
      opt.dataset.regions = JSON.stringify(regions);
      opt.dataset.price = price;
      instanceTypeSelect.appendChild(opt);
    }

    launchBtn.disabled = true;
  } catch {
    instanceTypeSelect.innerHTML = '<option value="">Failed to load</option>';
  }
}

// ── INSTANCE TYPE CHANGE → POPULATE REGIONS ──
instanceTypeSelect.addEventListener('change', () => {
  const opt = instanceTypeSelect.selectedOptions[0];
  regionSelect.innerHTML = '';

  if (!opt || !opt.value) {
    regionSelect.innerHTML = '<option value="">Select type first</option>';
    launchBtn.disabled = true;
    return;
  }

  const regions = JSON.parse(opt.dataset.regions || '[]');
  regions.forEach(r => {
    const o = document.createElement('option');
    o.value = r.name;
    o.textContent = r.description;
    regionSelect.appendChild(o);
  });

  launchBtn.disabled = false;
});

// ── LAUNCH ──
launchBtn.addEventListener('click', async () => {
  const instanceType = instanceTypeSelect.value;
  const region = regionSelect.value;
  if (!instanceType || !region) return;

  setGpuStatus('launching');

  try {
    const data = await api('/api/gpu/launch', {
      method: 'POST',
      body: JSON.stringify({ instance_type_name: instanceType, region_name: region }),
    });

    const ids = data.instance_ids || [data.instance_id];
    state.instanceId = ids[0];
    toast(`Instance ${state.instanceId} launched`, 'success');
    saveState();

    setGpuStatus('polling');
    pollInstanceStatus();
  } catch {
    setGpuStatus('error', 'Launch failed');
  }
});

// ── POLL INSTANCE STATUS ──
function pollInstanceStatus() {
  if (state.pollTimer) clearInterval(state.pollTimer);

  state.pollTimer = setInterval(async () => {
    try {
      const data = await api(`/api/gpu/status/${state.instanceId}`);

      if (data.status === 'active' && data.ip) {
        clearInterval(state.pollTimer);
        state.instanceIp = data.ip;
        saveState();

        // Auto-deploy
        setGpuStatus('deploying', data.ip);
        toast('Instance active — deploying stack...', 'success');

        try {
          const deployResult = await api(`/api/gpu/deploy/${state.instanceId}`, { method: 'POST' });
          if (deployResult.success) {
            setGpuStatus('ready', `<strong>${data.ip}</strong> <span class="cost-tag">$${instanceTypeSelect.selectedOptions[0]?.dataset.price || '?'}/hr</span>`);
            runBtn.disabled = !state.selectedFile;
            toast('Deploy complete — ready to upscale', 'success');
          } else {
            setGpuStatus('active', `<strong>${data.ip}</strong> — deploy failed, try manually`);
            toast('Deploy had issues: ' + (deployResult.error || 'unknown'), 'error');
          }
        } catch (e) {
          // Deploy failed but instance is still active — allow manual use
          setGpuStatus('active', `<strong>${data.ip}</strong> — deploy failed`);
          toast('Auto-deploy failed: ' + e.message, 'error');
          runBtn.disabled = !state.selectedFile;
        }
        saveState();
      } else {
        setGpuStatus('polling', data.status || '');
      }
    } catch {
      // keep polling on transient errors
    }
  }, 5000);
}

// ── TERMINATE ──
terminateBtn.addEventListener('click', async () => {
  if (!state.instanceId) return;

  try {
    await api('/api/gpu/terminate', {
      method: 'POST',
      body: JSON.stringify({ instance_ids: [state.instanceId] }),
    });

    if (state.pollTimer) clearInterval(state.pollTimer);
    if (state.jobPollTimer) clearInterval(state.jobPollTimer);

    state.instanceId = null;
    state.instanceIp = null;
    setGpuStatus('idle');
    localStorage.removeItem('artinafti_state');
    toast('Instance terminated', 'success');
  } catch {
    toast('Failed to terminate', 'error');
  }
});

// ── MODEL TABS ──
document.querySelectorAll('.model-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.model-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    state.activeModel = tab.dataset.model;

    document.querySelectorAll('[id^="params-"]').forEach(p => p.style.display = 'none');
    $(`params-${state.activeModel}`).style.display = '';

    const hints = {
      esrgan: 'ESRGAN — fast, no prompt needed',
      flux: 'FLUX — AI-enhanced, uses ~12GB VRAM',
      imagen: 'Imagen — Google Cloud powered',
    };
    $('modelHint').textContent = hints[state.activeModel];
  });
});

// ── RANGE INPUTS ──
document.querySelectorAll('input[type="range"]').forEach(r => {
  const valEl = $(r.id + '_val');
  if (!valEl) return;
  r.addEventListener('input', () => {
    if (r.id.includes('upscale_factor')) valEl.textContent = r.value + '×';
    else if (r.id.includes('denoise')) valEl.textContent = parseFloat(r.value).toFixed(2);
    else valEl.textContent = r.value;
  });
});

// ── DROPZONE ──
dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('drag-over');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files.length) handleFile(fileInput.files[0]);
});

function handleFile(file) {
  if (!file.type.match(/image\/(png|jpe?g|webp)/)) {
    toast('Only PNG, JPEG, WebP allowed', 'error');
    return;
  }

  state.selectedFile = file;

  const reader = new FileReader();
  reader.onload = e => {
    previewImg.src = e.target.result;
    previewContainer.classList.add('visible');
    dropzone.style.display = 'none';

    const img = new Image();
    img.onload = () => {
      previewInfo.textContent = `${file.name} · ${img.width}×${img.height} · ${(file.size / 1024 / 1024).toFixed(1)}MB`;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);

  runBtn.disabled = state.gpuStatus !== 'ready';
}

previewClear.addEventListener('click', () => {
  state.selectedFile = null;
  fileInput.value = '';
  previewContainer.classList.remove('visible');
  dropzone.style.display = '';
  runBtn.disabled = true;
});

// ── COLLECT PARAMS ──
function getParams() {
  const m = state.activeModel;

  if (m === 'esrgan') return {
    upscale_factor: parseInt($('esrgan_upscale_factor').value),
    model: $('esrgan_model').value,
    tile_size: parseInt($('esrgan_tile_size').value),
    use_fp16: $('esrgan_fp16').checked,
    use_two_pass: $('esrgan_two_pass').checked,
  };

  if (m === 'flux') return {
    upscale_factor: parseInt($('flux_upscale_factor').value),
    denoise: parseFloat($('flux_denoise').value),
    steps: parseInt($('flux_steps').value),
    guidance: parseFloat($('flux_guidance').value),
    seed: parseInt($('flux_seed').value),
    positive_prompt: $('flux_prompt').value || undefined,
  };

  if (m === 'imagen') return {
    upscale_factor: $('imagen_upscale_factor').value,
    prompt: $('imagen_prompt').value || undefined,
  };

  return {};
}

// ── RUN UPSCALE ──
runBtn.addEventListener('click', async () => {
  if (!state.selectedFile || !state.instanceIp) return;

  runBtn.disabled = true;
  outputEmpty.style.display = 'none';
  resultContainer.classList.remove('visible');
  progressWrap.classList.add('visible');
  progressFill.style.width = '0%';
  progressLabel.textContent = 'Uploading…';

  const formData = new FormData();
  formData.append('file', state.selectedFile);

  const params = getParams();
  for (const [k, v] of Object.entries(params)) {
    if (v !== undefined) formData.append(k, String(v));
  }

  try {
    const res = await fetch(`http://${state.instanceIp}:3000/api/upscale/${state.activeModel}`, {
      method: 'POST',
      body: formData,
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Upscale request failed');

    state.jobId = data.jobId;
    progressLabel.textContent = 'Queued…';
    pollJobStatus();
  } catch (e) {
    toast(e.message, 'error');
    progressWrap.classList.remove('visible');
    outputEmpty.style.display = '';
    runBtn.disabled = false;
  }
});

// ── POLL JOB STATUS ──
function pollJobStatus() {
  if (state.jobPollTimer) clearInterval(state.jobPollTimer);

  state.jobPollTimer = setInterval(async () => {
    try {
      const res = await fetch(`http://${state.instanceIp}:3000/api/upscale/status/${state.jobId}`);
      const data = await res.json();

      const pct = data.progress || 0;
      progressFill.style.width = `${pct}%`;
      progressLabel.textContent = `${data.status} — ${pct}%`;

      if (data.status === 'completed') {
        clearInterval(state.jobPollTimer);
        progressWrap.classList.remove('visible');

        const imgUrl = `http://${state.instanceIp}:3000${data.output_url}`;
        resultImg.src = imgUrl;

        let metaHtml = '';
        if (data.output_width && data.output_height) metaHtml += `<span>Size: <strong>${data.output_width}×${data.output_height}</strong></span>`;
        if (data.processing_time) metaHtml += `<span>Time: <strong>${data.processing_time.toFixed(1)}s</strong></span>`;
        resultMeta.innerHTML = metaHtml;

        resultContainer.classList.add('visible');
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = imgUrl;
          a.download = `artinafti-${state.jobId}.png`;
          a.click();
        };

        runBtn.disabled = false;
        toast('Upscale complete', 'success');
      }

      if (data.status === 'failed') {
        clearInterval(state.jobPollTimer);
        progressWrap.classList.remove('visible');
        outputEmpty.style.display = '';
        outputEmpty.textContent = `Failed: ${data.error || 'Unknown error'}`;
        runBtn.disabled = false;
        toast('Upscale failed', 'error');
      }
    } catch {
      // transient error, keep polling
    }
  }, 3000);
}

// ── STATE PERSISTENCE ──
function saveState() {
  const persist = {
    instanceId: state.instanceId,
    instanceIp: state.instanceIp,
    gpuStatus: state.gpuStatus,
    activeModel: state.activeModel,
  };
  localStorage.setItem('artinafti_state', JSON.stringify(persist));
}

function restoreState() {
  try {
    const saved = JSON.parse(localStorage.getItem('artinafti_state') || '{}');
    if (!saved.instanceId) return;

    state.instanceId = saved.instanceId;
    state.instanceIp = saved.instanceIp;
    state.activeModel = saved.activeModel || 'esrgan';

    // Restore model tab
    document.querySelectorAll('.model-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.model === state.activeModel);
    });
    document.querySelectorAll('[id^="params-"]').forEach(p => p.style.display = 'none');
    $(`params-${state.activeModel}`).style.display = '';

    // Re-check instance status
    if (saved.instanceId) {
      setGpuStatus('polling', 'Reconnecting…');
      pollInstanceStatus();
    }
  } catch {}
}

// ── INIT ──
loadInstanceTypes();
restoreState();
</script>
</body>
</html>
